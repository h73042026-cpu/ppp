{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0 text-primary">📋 تفاصيل الدفعة: {{ batch['name'] }}</h2>
    <div class="d-flex gap-2">
      <a href="{{ url_for('report', batch_id=batch['id']) }}" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> تقرير</a>
      <a href="{{ url_for('edit_batch', batch_id=batch['id']) }}" class="btn btn-outline-warning"><i class="bi bi-pencil"></i> تعديل</a>
      <a href="{{ url_for('delete_batch', batch_id=batch['id']) }}" class="btn btn-outline-danger" onclick="return confirm('هل أنت متأكد من حذف هذه الدفعة وجميع بياناتها؟')"><i class="bi bi-trash"></i> حذف</a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-md-3"><div class="muted">النوع</div><strong>{{ batch['breed'] }}</strong></div>
      <div class="col-md-3"><div class="muted">تاريخ البداية</div><strong>{{ batch['start_date'] }}</strong></div>
      <div class="col-md-3"><div class="muted">عدد الكتاكيت</div><strong>{{ batch['initial_count'] }}</strong></div>
      <div class="col-md-3"><div class="muted">سعر الفرخ</div><strong>{{ batch['chick_price'] }} ج.م</strong></div>
    </div>
  </div>

  <ul class="nav nav-pills mb-3" id="batchTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="feed-tab" data-bs-toggle="tab" data-bs-target="#feed" type="button" role="tab">🌾 العلف</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="meds-tab" data-bs-toggle="tab" data-bs-target="#meds" type="button" role="tab">💊 الأدوية</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="extras-tab" data-bs-toggle="tab" data-bs-target="#extras" type="button" role="tab">💰 مصروفات إضافية</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="mortality-tab" data-bs-toggle="tab" data-bs-target="#mortality" type="button" role="tab">☠️ النافق</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">💵 المبيعات</button>
    </li>
  </ul>

  <div class="tab-content" id="batchTabsContent">
    <!-- Feed -->
    <div class="tab-pane fade show active" id="feed" role="tabpanel" aria-labelledby="feed-tab">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <span>سجلات العلف</span>
          <a href="{{ url_for('add_feed', batch_id=batch['id']) }}" class="btn btn-light btn-sm"><i class="bi bi-plus-circle"></i> إضافة</a>
        </div>
        <div class="card-body">
          {% if feeds %}
          <div class="table-responsive p-2">
            <table class="table table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>النوع</th>
                  <th>الكمية</th>
                  <th>السعر</th>
                  <th class="text-nowrap">إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for f in feeds %}
                <tr>
                  <td>{{ f['date'] }}</td>
                  <td>{{ f['feed_type'] }}</td>
                  <td>{{ f['quantity'] }}</td>
                  <td>{{ f['price'] }}</td>
                  <td>
                    <a href="{{ url_for('edit_feed', id=f['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil"></i></a>
                    <a href="{{ url_for('delete_feed', id=f['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل تريد حذف هذا السجل؟')"><i class="bi bi-trash"></i></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted m-0">لا توجد بيانات.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Medications -->
    <div class="tab-pane fade" id="meds" role="tabpanel" aria-labelledby="meds-tab">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-warning d-flex justify-content-between align-items-center">
          <span>سجلات الأدوية</span>
          <a href="{{ url_for('add_med', batch_id=batch['id']) }}" class="btn btn-light btn-sm"><i class="bi bi-plus-circle"></i> إضافة</a>
        </div>
        <div class="card-body">
          {% if meds %}
          <div class="table-responsive p-2">
            <table class="table table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>الاسم</th>
                  <th>السبب</th>
                  <th>السعر</th>
                  <th class="text-nowrap">إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for m in meds %}
                <tr>
                  <td>{{ m['date'] }}</td>
                  <td>{{ m['name'] }}</td>
                  <td>{{ m['purpose'] }}</td>
                  <td>{{ m['price'] }}</td>
                  <td>
                    <a href="{{ url_for('edit_med', id=m['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil"></i></a>
                    <a href="{{ url_for('delete_med', id=m['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل تريد حذف هذا السجل؟')"><i class="bi bi-trash"></i></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted m-0">لا توجد بيانات.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Extras -->
    <div class="tab-pane fade" id="extras" role="tabpanel" aria-labelledby="extras-tab">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <span>سجلات المصروفات الإضافية</span>
          <a href="{{ url_for('add_extra', batch_id=batch['id']) }}" class="btn btn-light btn-sm"><i class="bi bi-plus-circle"></i> إضافة</a>
        </div>
        <div class="card-body">
          {% if extras %}
          <div class="table-responsive p-2">
            <table class="table table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>الاسم</th>
                  <th>السعر</th>
                  <th class="text-nowrap">إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for e in extras %}
                <tr>
                  <td>{{ e['date'] }}</td>
                  <td>{{ e['name'] }}</td>
                  <td>{{ e['price'] }}</td>
                  <td>
                    <a href="{{ url_for('edit_extra', id=e['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil"></i></a>
                    <a href="{{ url_for('delete_extra', id=e['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل تريد حذف هذا السجل؟')"><i class="bi bi-trash"></i></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted m-0">لا توجد بيانات.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Mortality -->
    <div class="tab-pane fade" id="mortality" role="tabpanel" aria-labelledby="mortality-tab">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <span>سجلات النافق اليومي</span>
          <a href="{{ url_for('add_mortality', batch_id=batch['id']) }}" class="btn btn-light btn-sm"><i class="bi bi-plus-circle"></i> إضافة</a>
        </div>
        <div class="card-body">
          {% if mortalities %}
          <div class="table-responsive p-2">
            <table class="table table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>العدد</th>
                  <th>ملاحظة</th>
                  <th class="text-nowrap">إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for d in mortalities %}
                <tr>
                  <td>{{ d['date'] }}</td>
                  <td>{{ d['count'] }}</td>
                  <td>{{ d['note'] }}</td>
                  <td>
                    <a href="{{ url_for('edit_mortality', id=d['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil"></i></a>
                    <a href="{{ url_for('delete_mortality', id=d['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل تريد حذف هذا السجل؟')"><i class="bi bi-trash"></i></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted m-0">لا توجد بيانات.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sales -->
    <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span>سجلات المبيعات</span>
          <a href="{{ url_for('add_sale', batch_id=batch['id']) }}" class="btn btn-light btn-sm"><i class="bi bi-plus-circle"></i> إضافة</a>
        </div>
        <div class="card-body">
          {% if sales %}
          <div class="table-responsive p-2">
            <table class="table table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>الكمية</th>
                  <th>وزن إجمالي (كجم)</th>
                  <th>سعر/كجم</th>
                  <th>الإجمالي (ج.م)</th>
                  <th class="text-nowrap">إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for s in sales %}
                <tr>
                  <td>{{ s['date'] }}</td>
                  <td>{{ s['quantity'] }}</td>
                  <td>{{ '%.2f'|format(s['total_weight_kg']) }}</td>
                  <td>{{ '%.2f'|format(s['price_per_kg']) }}</td>
                  <td>{{ '%.2f'|format(s['total_price']) }}</td>
                  <td>
                    <a href="{{ url_for('edit_sale', id=s['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil"></i></a>
                    <a href="{{ url_for('delete_sale', id=s['id'], batch_id=batch['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل تريد حذف هذا السجل؟')"><i class="bi bi-trash"></i></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted m-0">لا توجد بيانات.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-3">
    <a href="{{ url_for('index') }}" class="btn btn-outline-primary"><i class="bi bi-arrow-right"></i> رجوع</a>
  </div>
{% endblock %}
