{% extends "base.html" %}
{% block content %}
    <h3 class="mb-3">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø©: {{ batch['name'] }}</h3>

    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3">
          <div class="muted">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</div>
          <h5 class="mt-1 date-col">{{ batch['start_date'] }}</h5>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div class="muted">ğŸ£ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØªØ§ÙƒÙŠØª</div>
          <h5 class="mt-1">{{ batch['initial_count'] }}</h5>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div class="muted">ğŸ’¸ Ø³Ø¹Ø± Ø§Ù„ÙƒØªÙƒÙˆØª Ø§Ù„ÙˆØ§Ø­Ø¯</div>
          <h5 class="mt-1">{{ batch['chick_price'] }} Ø¬.Ù…</h5>
        </div>
      </div>
    </div>

    <h5 class="mt-4 mb-2">ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h5>
    <div class="table-responsive p-2">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¨Ù†Ø¯</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¬.Ù…)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±Ø§Ø®</td>
            <td>{{ chicks_total }}</td>
          </tr>
          <tr>
            <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù„Ù</td>
            <td>{{ feed_total }}</td>
          </tr>
          <tr>
            <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</td>
            <td>{{ meds_total }}</td>
          </tr>
          <tr>
            <td>Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©</td>
            <td>{{ extra_total }}</td>
          </tr>
          <tr class="table-secondary">
            <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</strong></td>
            <td><strong>{{ total_expenses }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    <h5 class="mt-4 mb-2">ğŸ“¦ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©</h5>
    <div class="card p-3">
      <div class="row">
        <div class="col-md-3"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø§ÙÙ‚:</strong> {{ total_mortality }}</div>
        <div class="col-md-3"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø¹:</strong> {{ total_sold_qty }}</div>
        <div class="col-md-3"><strong>ÙˆØ²Ù† Ø§Ù„Ù…Ø¨Ø§Ø¹ (ÙƒØ¬Ù…):</strong> {{ '%.2f'|format(total_sold_weight) }}</div>
        <div class="col-md-3"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</strong> {{ birds_remaining }}</div>
      </div>
    </div>

    <h5 class="mt-4 mb-2">ğŸ’µ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h5>
    <div class="card p-3">
      <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</strong> {{ '%.2f'|format(sales_total or 0) }} Ø¬.Ù…</div>
      <div><strong>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© :</strong> {{ '%.2f'|format((sales_total or 0) - total_expenses) }} Ø¬.Ù…</div>
    </div>

    <h5 class="mt-4 mb-2">ğŸ§® ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø­ (Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ)</h5>
    <div class="card p-3">
      <form method="post">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
            <input type="number" step="0.01" min="0" name="average_weight_kg" class="form-control" value="{{ average_weight_kg if average_weight_kg is not none else '' }}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ (Ø¬.Ù…)</label>
            <input type="number" step="0.01" min="0" name="price_per_kg" class="form-control" value="{{ price_per_kg if price_per_kg is not none else '' }}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù†Ø§ÙÙ‚</label>
            <input type="number" step="1" min="0" max="{{ batch['initial_count'] }}" name="mortality_count" class="form-control" value="{{ mortality_count if mortality_count is not none else 0 }}">
          </div>
        </div>
        <div class="mt-3 text-center">
          <button type="submit" class="btn btn-success">Ø­Ø³Ø§Ø¨</button>
        </div>
      </form>
    </div>

    {% if revenue_estimate is not none %}
    <div class="card p-3 mt-3" id="calculationResults">
      <div class="row">
        <div class="col-md-3"><strong>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</strong> {{ birds_available }} Ø·Ø§Ø¦Ø±</div>
        <div class="col-md-3"><strong>Ø¥ÙŠØ±Ø§Ø¯ ØªÙ‚Ø¯ÙŠØ±ÙŠ:</strong> {{ '%.2f'|format(revenue_estimate) }} Ø¬.Ù…</div>
        <div class="col-md-3"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> {{ '%.2f'|format(total_expenses) }} Ø¬.Ù…</div>
        <div class="col-md-3"><strong>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©:</strong> {{ '%.2f'|format(profit_estimate) }} Ø¬.Ù…</div>
      </div>
    </div>
    {% endif %}

    <h5 class="mt-4 mb-2">ğŸ“ˆ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©</h5>
    <div class="card p-3">
      <div class="row g-3">
        <div class="col-md-6">
          <canvas id="expensesChart" height="160"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="salesVsExpensesChart" height="160"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <a href="{{ url_for('view_batch', batch_id=batch['id']) }}" class="btn btn-secondary">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Scroll to results if they exist
      document.addEventListener('DOMContentLoaded', function() {
        const resultsSection = document.getElementById('calculationResults');
        if (resultsSection) {
          resultsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });

      const rtl = true;
      // Expenses breakdown (Doughnut)
      const expCtx = document.getElementById('expensesChart').getContext('2d');
      new Chart(expCtx, {
        type: 'doughnut',
        data: {
          labels: ['ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±Ø§Ø®', 'Ø§Ù„Ø¹Ù„Ù', 'Ø§Ù„Ø£Ø¯ÙˆÙŠØ©', 'Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©'],
          datasets: [{
            data: [{{ chicks_total|default(0) }}, {{ feed_total|default(0) }}, {{ meds_total|default(0) }}, {{ extra_total|default(0) }}],
            backgroundColor: ['#0ea5e9','#84cc16','#f59e0b','#a855f7'],
            borderWidth: 0
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } },
          maintainAspectRatio: false
        }
      });

      // Sales vs Expenses (Bar)
      const seCtx = document.getElementById('salesVsExpensesChart').getContext('2d');
      new Chart(seCtx, {
        type: 'bar',
        data: {
          labels: ['Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'],
          datasets: [{
            label: 'Ø¬.Ù…',
            data: [{{ (sales_total or 0)|default(0) }}, {{ total_expenses|default(0) }}],
            backgroundColor: ['#22c55e','#ef4444']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } },
          maintainAspectRatio: false
        }
      });
    </script>
{% endblock %}
